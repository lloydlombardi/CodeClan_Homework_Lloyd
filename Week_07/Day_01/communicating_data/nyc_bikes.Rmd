---
title: "NYC Bikes Report"
output: html_notebook
---
# Domain Knowledge 1.1 

__NYC Citi Bikes__ is a bike share program which offers customers the opportunity to explore NYC and the surrounding areas by bike.
With over 1,500 stations and over 25,000 bikes, there is a __lot__ of data that could be collected and analysed in order to understand the trends of the customers using the bikes.

This report investigates and analyses the data of __10 NYC Citi Bikes__ that were used in the Jersey City area in 2018.

The following terms will be used across the entirety of this report:

- __Customer__: Someone who has purchased either a 24-hour or a 3-day pass
- __Subscriber__: Someone who has an annual subscription
- __KPI__: The Key Performance Indicator is to increase bike hires

The following points were considered for the report:

- What is the pattern of bike hires over time (e.g. within a year, month, week, or day)?
- Do bike hire patterns differ between bike rider demographics (e.g. gender, type of trip, age)?

# Business Requirements 1.2

To answer the above questions regarding pattern of hire over time and changing demographics, the following steps were taken:

1. Load in and study the data
2. Wrangle the data by manipulating the time-series columns
    - Create a Year column
    - Create a Month column
    - Create a Date column
    - Create a Day of Week column
    - Create a Season column
    - Create a Ride Duration column
3. Investigate the proportion of customer types (Customer v Subscriber)
4. Visualise the pattern of hire change over time
5. Visualise the pattern of bike rider demographics by customer type
6. Visualise the pattern of bike rider demographics by gender
7. Visualise the geographical spread of the start-points
8. Interpret the visualisations and make recommendations

# Business Processes and Data Flow 1.3



```{r eval=FALSE}
library(tidyverse)
library(janitor)
library(tsibble)
library(brew)
library(lubridate)
library(feasts)
library(sf)
library(leaflet)
library(slider)
```


```{r}
nyc_bikes <- tsibbledata::nyc_bikes %>% clean_names()
```


```{r}
glimpse(nyc_bikes)
```


```{r}
nyc_bikes %>% 
  filter(is.na(bike_id:gender))
```


```{r}
nyc_bikes %>% 
  distinct(type)

nyc_bikes %>% 
  distinct(start_station)

nyc_bikes %>% 
  distinct(gender)
```


```{r}
nyc_bikes %>% 
  group_by(gender) %>% 
  summarise(count = n())
```

```{r}
nyc_bikes %>% 
  group_by(type, gender) %>% 
  summarise(count = n())
```


```{r}
nyc_bikes %>% 
  group_by(type, gender, birth_year) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count))
```


```{r}
nyc_bikes <- nyc_bikes %>% 
  mutate(month_of_ride = month(start_time, label = TRUE, abbr = FALSE),
         day_of_week_ride = wday(start_time, label = TRUE, abbr = TRUE),
         year_of_ride = year(start_time),
         date = as_date(start_time),
         ride_duration = as.numeric(as.period(stop_time - start_time), "minutes"),
         season = case_when(
           str_detect(month_of_ride, "December") ~ "Winter",
           str_detect(month_of_ride, "January") ~ "Winter",
           str_detect(month_of_ride, "February") ~ "Winter",
           str_detect(month_of_ride, "March") ~ "Spring",
           str_detect(month_of_ride, "April") ~ "Spring",
           str_detect(month_of_ride, "May") ~ "Spring",
           str_detect(month_of_ride, "June") ~ "Summer",
           str_detect(month_of_ride, "July") ~ "Summer",
           str_detect(month_of_ride, "August") ~ "Summer",
           str_detect(month_of_ride, "September") ~ "Autumn",
           str_detect(month_of_ride, "October") ~ "Autumn",
           str_detect(month_of_ride, "November") ~ "Autumn",
         ),
         season = factor(season, order = TRUE),
         .after = stop_time)
```



```{r}
monthly_hires <- nyc_bikes %>% 
  index_by(month_of_ride) %>% 
  summarise(count = n())

monthly_hires %>% 
  ggplot(aes(x = month_of_ride,
             y = count,
             label = count)) +
  geom_point(colour = "#003A72", size = 2) +
  geom_line(group = 1, colour = "#DB230B")+
  geom_text(vjust = -1, hjust = 1) +
  theme_light() +
  theme(
    text = element_text(size = 20)
  ) +
  labs(x = "\nMonth of Year",
       y = "Number of Bike Rides",
       title = "Number of Bike Rides per Month\n")
```


```{r}
nyc_bikes %>%
  filter(ride_duration <= 100) %>% 
  index_by(month_of_ride) %>%
  summarise(sum_monthly_ride_time = sum(ride_duration)) %>% 
  ggplot(aes(x = month_of_ride,
             y = sum_monthly_ride_time)) +
  geom_point(colour = "#003A72", size = 2) +
  geom_line(group = 1, colour = "#DB230B")+
  theme_light() +
  theme(
    text = element_text(size = 20)
  ) +
  labs(x = "\nMonth of Year",
       y = "Total Ride Duration (minutes)",
       title = "Ride Duration per Month\n")
```


```{r}
nyc_bikes %>%
  filter(ride_duration <= 100) %>% 
  index_by(month_of_ride) %>%
  summarise(mean_monthly_ride_time = mean(ride_duration)) %>% 
  ggplot(aes(x = month_of_ride,
             y = mean_monthly_ride_time)) +
  geom_point(colour = "#003A72", size = 2) +
  geom_line(group = 1, colour = "#DB230B")+
  theme_light() +
  theme(
    text = element_text(size = 20)
  ) +
  labs(x = "\nMonth of Year",
       y = "Mean Ride Duration (minutes)",
       title = "Mean Ride Duration per Month\n")
```


```{r, echo=FALSE}
nyc_bikes %>% 
  index_by(season) %>%
  group_by(type) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = season,
             y = count)) +
  geom_col(aes(fill = type),
           alpha = 0.8, position = "dodge") +
  scale_x_discrete(limits = c("Spring", "Summer", "Autumn", "Winter")) +
  scale_fill_manual(values = c("#003A72", "#DB230B")) +
  theme_light() +
  labs(x = "\nSeason",
       y = "Number of Bike Rides",
       title = "Number of Bike Rides per Season\n",
       fill = "Customer Type")
```


```{r, echo=FALSE}
nyc_bikes %>%
  filter(ride_duration <= 100) %>% 
  index_by(season) %>%
  group_by(type) %>% 
  summarise(sum_season_ride_time = sum(ride_duration)) %>%
  ggplot(aes(x = season,
             y = sum_season_ride_time)) +
   geom_col(aes(fill = type),
            alpha = 0.8, position = "dodge") +
  scale_x_discrete(limits = c("Spring", "Summer", "Autumn", "Winter")) +
  scale_fill_manual(values = c("#003A72", "#DB230B")) +
  theme_light() +
  labs(x = "\nSeason",
       y = "Total Ride Time (minutes)",
       title = "Total Ride Time per Season\n",
       fill = "Customer Type")
```


```{r, echo=FALSE}
nyc_bikes %>% 
  filter(ride_duration <= 100) %>% 
  index_by(season) %>%
  group_by(type) %>% 
  summarise(mean_seasonal_ride_time = mean(ride_duration)) %>% 
  ggplot(aes(x = season,
             y = mean_seasonal_ride_time)) +
  geom_col(aes(fill = type),
           alpha = 0.8,
           position = "dodge") +
  scale_x_discrete(limits = c("Spring", "Summer", "Autumn", "Winter")) +
  scale_fill_manual(values = c("#003A72", "#DB230B")) +
  theme_light() +
  theme(
    text = element_text(size = 20)
  ) +
  labs(x = "\nSeason",
       y = "Mean Ride Time (minutes)",
       title = "Mean Ride Time per Season\n",
       fill = "Customer Type")
```



```{r}
dow_hires <- nyc_bikes %>% 
  index_by(day_of_week_ride) %>% 
  summarise(count = n())

dow_hires %>% 
  ggplot(aes(x = day_of_week_ride,
             y = count)) +
  geom_point() +
  geom_line(group = 1)
```



```{r}
nyc_bikes %>%
  filter(ride_duration < 150) %>% 
  ggplot(aes(x = ride_duration)) +
  geom_histogram(bins = 100, col = "white") +
  scale_x_log10()
```


```{r}
nyc_bikes %>% 
  mutate(type = factor(type, order = TRUE)) %>% 
  index_by(type) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = type,
         y = count)) +
  geom_col(aes(fill = type),
           alpha = 0.8) +
  scale_x_discrete(limits = c("Customer", "Subscriber")) +
  scale_fill_manual(values = c("#003A72", "#DB230B")) +
  geom_text(aes(label = paste0(round(count / sum(count) * 100, digits = 1), "%")), vjust = -0.25)+
  theme_light() +
  theme(
    text = element_text(size = 20)
  ) +
  theme(legend.position = "none") +
  labs(x = "\nCustomer Type",
       y = "Number of Customers",
       title = "Number of Customer Types\n")
```


```{r}
nyc_bikes %>%
  filter(ride_duration <= 100) %>% 
  index_by(month_of_ride) %>%
  group_by(type) %>% 
  mutate(mean_monthly_ride_time = mean(ride_duration)) %>% 
  ggplot(aes(x = month_of_ride,
             y = mean_monthly_ride_time)) +
  geom_point(size = 1) +
  geom_line(aes(group = type, colour = type)) +
  scale_color_manual(values = c("#003A72", "#DB230B")) +
  theme_light() +
  theme(
    text = element_text(size = 20)
  ) +
  labs(x = "\nMonth of Year",
       y = "Mean Ride Duration (minutes)",
       title = "Mean Ride Duration per Month by Customer\n",
       colour = "Customer Type")
```


```{r}
nyc_bikes %>%
  filter(ride_duration <= 100) %>% 
  index_by(month_of_ride) %>%
  group_by(type) %>% 
  mutate(sum_monthly_ride_time = sum(ride_duration)) %>% 
  ggplot(aes(x = month_of_ride,
             y = sum_monthly_ride_time)) +
  geom_point(size = 1) +
  geom_line(aes(group = type, colour = type)) +
  scale_color_manual(values = c("#003A72", "#DB230B")) +
  theme_light() +
  theme(
    text = element_text(size = 20)
  ) +
  labs(x = "\nMonth of Year",
       y = "Total Ride Duration (minutes)",
       title = "Total Ride Duration per Month by Customer\n",
       colour = "Customer Type")
```


```{r}
nyc_bikes %>%
  filter(ride_duration <= 100) %>% 
  index_by(month_of_ride) %>%
  group_by(gender) %>% 
  mutate(mean_monthly_ride_time = mean(ride_duration)) %>% 
  ggplot(aes(x = month_of_ride,
             y = mean_monthly_ride_time)) +
  geom_point(size = 1) +
  geom_line(aes(group = gender, colour = gender))
```


```{r}
nyc_bikes %>%
  filter(ride_duration <= 100) %>% 
  index_by(month_of_ride) %>%
  group_by(gender) %>% 
  mutate(sum_monthly_ride_time = sum(ride_duration)) %>% 
  ggplot(aes(x = month_of_ride,
             y = sum_monthly_ride_time)) +
  geom_line(aes(group = gender, colour = gender))
```



```{r}
nyc_bikes %>%
  filter(type == "Customer") %>% 
  index_by(year_of_ride) %>% 
  group_by(type, gender) %>% 
  summarise(count = n()) %>% 
  ggplot() +
  geom_col(aes(x = type,
               y = count,
               fill = gender),
           position = "dodge")
```




```{r}
leaflet(nyc_bikes) %>% 
  addTiles() %>% 
  addMarkers(
    lng = ~start_long,
    lat = ~start_lat,
    popup = ~paste("Station:", start_station)
  )
```



```{r}
# library(infer)
# 
# observed_stat <- nyc_bikes %>% 
#   specify(response = type, success = "Customer") %>% 
#   calculate(stat = "prop")
# 
# null_distribution <- nyc_bikes %>% 
#   specify(response = type, success = "Customer") %>% 
#   hypothesise(null = "point", p = 0.075) %>% 
#   generate(reps = 50000, type = "draw") %>% 
#   calculate(stat = "prop")
# 
# null_distribution %>% 
#   visualise()+
#   shade_p_value(obs_stat = observed_stat, direction = "left")
# 
# null_distribution %>% 
#   get_p_value(obs_stat = observed_stat, direction = "left")
```


```{r}
daily_hires <- nyc_bikes %>% 
  index_by(date) %>% 
  summarise(count = n())

daily_hires %>% 
  ggplot(aes(x = date,
             y = count)) +
  geom_line()
```


```{r}
rolling <- nyc_bikes %>%
  filter(ride_duration <= 100) %>% 
  index_by(date) %>% 
  mutate(
    duration_moving_average = slide_dbl(
      .x = ride_duration,
      .f = ~ mean(.x),
      .before = 500,
      .after = 500,
      complete = TRUE
    )
  )

rolling %>% 
  ggplot() +
  geom_line(aes(x = date,
                y = ride_duration),
            colour = "grey") +
  geom_line(aes(x = date,
                y = duration_moving_average),
            colour = "red")
```








